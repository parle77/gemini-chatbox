name: Deploy Guto Chatbot

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Debug - Check files and secrets
      run: |
        echo "üìÅ Repository files:"
        ls -la
        echo ""
        echo "üîë Secrets status:"
        [ -n "${{ secrets.GEMINI_API_KEY }}" ] && echo "‚úÖ GEMINI_API_KEY: Set" || echo "‚ùå GEMINI_API_KEY: NOT SET"
        [ -n "${{ secrets.SUPABASE_URL }}" ] && echo "‚úÖ SUPABASE_URL: Set" || echo "‚ö†Ô∏è  SUPABASE_URL: Not set (optional)"
        [ -n "${{ secrets.SUPABASE_ANON_KEY }}" ] && echo "‚úÖ SUPABASE_ANON_KEY: Set" || echo "‚ö†Ô∏è  SUPABASE_ANON_KEY: Not set (optional)"
        
    - name: Replace placeholders with secrets
      env:
        GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
        SUPABASE_URL_VAL: ${{ secrets.SUPABASE_URL || '__SUPABASE_URL__' }}
        SUPABASE_KEY_VAL: ${{ secrets.SUPABASE_ANON_KEY || '__SUPABASE_ANON_KEY__' }}
      run: |
        echo "üîÑ Replacing placeholders..."
        
        # Verify API key exists
        if [ -z "$GEMINI_KEY" ]; then
          echo "‚ùå CRITICAL ERROR: GEMINI_API_KEY secret is empty!"
          echo "Go to: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Repository secrets"
          exit 1
        fi
        
        echo "‚úÖ GEMINI_API_KEY is set (length: ${#GEMINI_KEY})"
        
        # Create backup
        cp index.html index.html.backup
        
        # Replace using sed with | delimiter to avoid issues with URLs
        sed -i "s|__GEMINI_API_KEY__|${GEMINI_KEY}|g" index.html
        sed -i "s|__SUPABASE_URL__|${SUPABASE_URL_VAL}|g" index.html
        sed -i "s|__SUPABASE_ANON_KEY__|${SUPABASE_KEY_VAL}|g" index.html
        
        echo "‚úÖ Replacement completed"
        
    - name: Verify replacement
      run: |
        echo "üîç Verifying replacements..."
        
        if grep -q "__GEMINI_API_KEY__" index.html; then
          echo "‚ùå ERROR: GEMINI_API_KEY placeholder still exists!"
          echo "Showing CONFIG section:"
          grep -A 3 "GEMINI_API_KEY:" index.html | head -5
          exit 1
        fi
        
        echo "‚úÖ GEMINI_API_KEY successfully replaced"
        echo "Preview (first 25 chars): $(grep "GEMINI_API_KEY:" index.html | grep -o "'[^']*'" | head -1 | cut -c 1-25)..."
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Deployment complete
      run: |
        echo "================================================"
        echo "üöÄ DEPLOYMENT SUCCESSFUL!"
        echo "================================================"
        echo "üåê Your chatbot is live at:"
        echo "${{ steps.deployment.outputs.page_url }}"
        echo ""
        echo "‚è±Ô∏è  Wait 1-2 minutes, then visit your site"
        echo "üîÑ Hard refresh: Ctrl+Shift+R (Windows) or Cmd+Shift+R (Mac)"
        echo "================================================"
