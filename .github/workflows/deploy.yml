name: Deploy to GitHub Pages
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Debug - List files
      run: |
        echo "=== FILES IN REPOSITORY ==="
        ls -la
        echo ""
        
    - name: Debug - Check for placeholders
      run: |
        echo "=== CHECKING FOR PLACEHOLDERS IN index.html ==="
        if [ -f "index.html" ]; then
          echo "‚úÖ index.html exists"
          grep -n "PLACEHOLDER_GEMINI_KEY" index.html && echo "‚úÖ Found GEMINI placeholder" || echo "‚ùå GEMINI placeholder NOT found"
          grep -n "PLACEHOLDER_SUPABASE_URL" index.html && echo "‚úÖ Found SUPABASE_URL placeholder" || echo "‚ùå SUPABASE_URL placeholder NOT found"
          grep -n "PLACEHOLDER_SUPABASE_KEY" index.html && echo "‚úÖ Found SUPABASE_KEY placeholder" || echo "‚ùå SUPABASE_KEY placeholder NOT found"
        else
          echo "‚ùå index.html NOT FOUND!"
          exit 1
        fi
        echo ""
        
    - name: Debug - Check secrets
      run: |
        echo "=== CHECKING SECRETS ==="
        echo "GEMINI_API_KEY exists: ${{ secrets.GEMINI_API_KEY != '' && '‚úÖ Yes' || '‚ùå No' }}"
        echo "GEMINI_API_KEY length: ${{ secrets.GEMINI_API_KEY != '' && 'Set' || 'Not Set' }}"
        echo "SUPABASE_URL exists: ${{ secrets.SUPABASE_URL != '' && '‚úÖ Yes' || '‚ùå No' }}"
        echo "SUPABASE_ANON_KEY exists: ${{ secrets.SUPABASE_ANON_KEY != '' && '‚úÖ Yes' || '‚ùå No' }}"
        echo ""
        
    - name: Replace placeholders with secrets
      env:
        GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
        SUPABASE_URL_SECRET: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY_SECRET: ${{ secrets.SUPABASE_ANON_KEY }}
      run: |
        echo "üîÑ Starting placeholder replacement..."
        
        # Verify file exists
        if [ ! -f "index.html" ]; then
          echo "‚ùå ERROR: index.html not found!"
          exit 1
        fi
        
        # Check if environment variables are set
        if [ -z "$GEMINI_KEY" ]; then
          echo "‚ùå ERROR: GEMINI_KEY is empty - check your GitHub Secret 'GEMINI_API_KEY'"
          exit 1
        else
          echo "‚úÖ GEMINI_KEY is set (length: ${#GEMINI_KEY})"
        fi
        
        if [ -z "$SUPABASE_URL_SECRET" ]; then
          echo "‚ö†Ô∏è  WARNING: SUPABASE_URL_SECRET is empty"
          SUPABASE_URL_SECRET="PLACEHOLDER_SUPABASE_URL"
        else
          echo "‚úÖ SUPABASE_URL_SECRET is set"
        fi
        
        if [ -z "$SUPABASE_KEY_SECRET" ]; then
          echo "‚ö†Ô∏è  WARNING: SUPABASE_KEY_SECRET is empty"
          SUPABASE_KEY_SECRET="PLACEHOLDER_SUPABASE_KEY"
        else
          echo "‚úÖ SUPABASE_KEY_SECRET is set"
        fi
        
        # Create backup
        cp index.html index.html.backup
        
        # Replace placeholders using sed with different delimiter to avoid issues
        echo "Replacing GEMINI_API_KEY..."
        sed -i "s|PLACEHOLDER_GEMINI_KEY|${GEMINI_KEY}|g" index.html
        
        echo "Replacing SUPABASE_URL..."
        sed -i "s|PLACEHOLDER_SUPABASE_URL|${SUPABASE_URL_SECRET}|g" index.html
        
        echo "Replacing SUPABASE_ANON_KEY..."
        sed -i "s|PLACEHOLDER_SUPABASE_KEY|${SUPABASE_KEY_SECRET}|g" index.html
        
        echo "‚úÖ Replacement commands executed"
        echo ""
        
    - name: Verify replacement
      run: |
        echo "=== VERIFYING REPLACEMENT ==="
        
        # Check if any placeholders remain
        if grep -q "PLACEHOLDER_GEMINI_KEY" index.html; then
          echo "‚ùå ERROR: PLACEHOLDER_GEMINI_KEY still exists in index.html"
          echo "Showing context:"
          grep -n "PLACEHOLDER_GEMINI_KEY" index.html
          exit 1
        else
          echo "‚úÖ GEMINI_API_KEY successfully replaced"
        fi
        
        if grep -q "PLACEHOLDER_SUPABASE_URL" index.html; then
          echo "‚ö†Ô∏è  WARNING: PLACEHOLDER_SUPABASE_URL still exists (this is OK if not using Supabase)"
        else
          echo "‚úÖ SUPABASE_URL successfully replaced"
        fi
        
        if grep -q "PLACEHOLDER_SUPABASE_KEY" index.html; then
          echo "‚ö†Ô∏è  WARNING: PLACEHOLDER_SUPABASE_KEY still exists (this is OK if not using Supabase)"
        else
          echo "‚úÖ SUPABASE_ANON_KEY successfully replaced"
        fi
        
        # Show a snippet of the config section (without revealing full keys)
        echo ""
        echo "=== CONFIG SECTION (first 50 chars of each value) ==="
        grep -A 5 "const CONFIG" index.html | head -10
        echo ""
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        force_orphan: true
        
    - name: Deployment Summary
      run: |
        echo "================================================"
        echo "üöÄ DEPLOYMENT COMPLETED SUCCESSFULLY!"
        echo "================================================"
        echo "Your chatbot should be live at:"
        echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo ""
        echo "If you see 'API Configuration Required' error:"
        echo "1. Check the Actions logs above for any errors"
        echo "2. Verify your GitHub Secret 'GEMINI_API_KEY' is set correctly"
        echo "3. Wait 2-3 minutes for GitHub Pages to update"
        echo "4. Clear your browser cache and refresh"
        echo "================================================"
