<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant Chatbot</title>
    <style>
        /* Modern Chat Interface with Custom Brand Colors */
        :root {
            --primary-color: #226137;
            --secondary-color: #FCB1A8;
            --third-color: #F26D14;
            --fourth-color: #F6D635;
            --background-color: #FFFFFF;
            --text-color: #333333;
            --light-gray: #f7f8fa;
            --border-gray: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--primary-color);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chat-container {
            width: 100%;
            max-width: 480px;
            height: 90vh;
            max-height: 700px;
            background: var(--background-color);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(34, 97, 55, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: var(--primary-color);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .chat-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--fourth-color);
        }

        .bot-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bot-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid var(--fourth-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .bot-name {
            font-size: 18px;
            font-weight: 600;
        }

        .bot-status {
            font-size: 12px;
            opacity: 0.9;
            color: var(--fourth-color);
        }

        .settings-btn {
            display: none;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            font-size: 20px;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(45deg);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--light-gray);
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            gap: 10px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--third-color);
            border: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .message-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 70%;
        }

        .message.user .message-wrapper {
            align-items: flex-end;
        }

        .message.bot .message-wrapper {
            align-items: flex-start;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
            margin-bottom: 5px;
        }

        .message.user .message-content {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 8px rgba(34, 97, 55, 0.2);
        }

        .message.bot .message-content {
            background: var(--third-color);
            color: white;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .message-time {
            font-size: 11px;
            opacity: 0.6;
            color: var(--text-color);
        }

        .typing-indicator {
            display: none;
            padding: 15px;
            background: white;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            border: 1px solid var(--secondary-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            width: fit-content;
            margin: 0 20px 10px 20px;
        }

        .typing-indicator.active {
            display: block;
        }

        .typing-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--third-color);
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
            background: var(--primary-color);
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
            background: var(--fourth-color);
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 2px solid var(--secondary-color);
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-gray);
            border-radius: 25px;
            font-size: 15px;
            outline: none;
            transition: all 0.3s;
            color: var(--text-color);
        }

        .chat-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(34, 97, 55, 0.1);
        }

        .send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary-color);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(34, 97, 55, 0.3);
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.1);
            background: var(--third-color);
            box-shadow: 0 4px 12px rgba(34, 97, 55, 0.4);
        }

        .send-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 20px;
            font-size: 14px;
            display: none;
            border-left: 4px solid var(--third-color);
        }

        .error-message.active {
            display: block;
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(34, 97, 55, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .settings-modal.active {
            display: flex;
        }

        .settings-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(34, 97, 55, 0.3);
            border-top: 4px solid var(--primary-color);
        }

        .settings-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .settings-group {
            margin-bottom: 15px;
        }

        .settings-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--text-color);
            font-weight: 500;
        }

        .settings-input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            color: var(--text-color);
        }

        .settings-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(34, 97, 55, 0.1);
        }

        textarea.settings-input {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .settings-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .settings-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .settings-btn.save {
            background: var(--primary-color);
            color: white;
        }

        .settings-btn.save:hover {
            transform: translateY(-2px);
            background: var(--third-color);
            box-shadow: 0 4px 12px rgba(34, 97, 55, 0.3);
        }

        .settings-btn.cancel {
            background: var(--secondary-color);
            color: var(--text-color);
        }

        .settings-btn.cancel:hover {
            background: #f5a099;
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        /* Welcome message special styling */
        .message.bot:first-child .message-content {
            background: var(--third-color);
            border: none;
            color: white;
        }

        /* Loading animation for better UX */
        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="bot-info">
                <div class="bot-avatar">🤖</div>
                <div>
                    <div class="bot-name">Ask ELLE</div>
                    <div class="bot-status">● Online</div>
                </div>
            </div>
            <button class="settings-btn" id="settingsButton" style="display: none;">⚙️</button>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div class="message-avatar">🤖</div>
                <div class="message-wrapper">
                    <div class="message-content">
                        <div>Hello! I'm Elle, your gut health assistant. How can I help you today?</div>
                    </div>
                    <div class="message-time"></div>
                </div>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="chat-input-container">
            <div class="input-wrapper">
                <input 
                    type="text" 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="Type your message..."
                >
                <button class="send-btn" id="sendBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <h2 class="settings-title">⚙️ Settings</h2>
            
            <div class="settings-group">
                <label class="settings-label">User ID</label>
                <input type="text" class="settings-input" id="userIdInput" placeholder="Enter your user ID">
            </div>
            
            <div class="settings-group">
                <label class="settings-label">System Prompt (Topic Training)</label>
                <textarea class="settings-input" id="systemPromptInput" rows="4" placeholder="Enter system prompt to train the bot on specific topics..."></textarea>
            </div>
            
            <div class="settings-buttons">
                <button class="settings-btn cancel" id="cancelSettings">Cancel</button>
                <button class="settings-btn save" id="saveSettingsBtn">Save</button>
            </div>
        </div>
    </div>

    <script>
    // Configuration - placeholders will be replaced by GitHub Actions
    const CONFIG = {
        GEMINI_API_KEY: 'PLACEHOLDER_GEMINI_KEY',
        SUPABASE_URL: 'PLACEHOLDER_SUPABASE_URL',
        SUPABASE_ANON_KEY: 'PLACEHOLDER_SUPABASE_KEY',
        DEFAULT_SYSTEM_PROMPT: 'You are Elle, a specialized gut health assistant for the Gutty app. You help users with digestive health questions, gut microbiome information, probiotic and prebiotic guidance, IBS, IBD, and digestive disorder support, and nutrition for gut health. Always be friendly, supportive, and remind users to consult healthcare professionals for serious issues.',
        BOT_NAME: 'Elle',
        BOT_AVATAR: '🤖'
    };
    
    console.log('Config loaded: API key is ready');
    console.log('Supabase configured:', (CONFIG.SUPABASE_URL && CONFIG.SUPABASE_URL !== 'PLACEHOLDER_SUPABASE_URL' && CONFIG.SUPABASE_URL.startsWith('https://')) ? 'Yes' : 'No');
    console.log('Supabase URL length:', CONFIG.SUPABASE_URL ? CONFIG.SUPABASE_URL.length : 'undefined');
    console.log('Supabase Key length:', CONFIG.SUPABASE_ANON_KEY ? CONFIG.SUPABASE_ANON_KEY.length : 'undefined');

    // Initialize variables
    let userId = localStorage.getItem('userId') || generateUserId();
    let sessionId = generateSessionId();
    let systemPrompt = localStorage.getItem('systemPrompt') || CONFIG.DEFAULT_SYSTEM_PROMPT;
    let chatHistory = [];
    let isInitialLoad = true;

    // Generate unique IDs
    function generateUserId() {
        const id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', id);
        return id;
    }

    function generateSessionId() {
        return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Format time
    function formatTime(date) {
        return new Intl.DateTimeFormat('en-US', {
            hour: 'numeric',
            minute: 'numeric',
            hour12: true
        }).format(date);
    }

    // Add message to chat UI
    function addMessageToUI(message, sender, timestamp = null, isFromHistory = false) {
        // Skip welcome message if loading from history
        if (isFromHistory && sender === 'bot' && message.includes('Hello! I\'m Elle')) {
            return;
        }

        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        // Add avatar for bot messages
        if (sender === 'bot') {
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.textContent = '🤖';
            messageDiv.appendChild(avatarDiv);
        }
        
        const wrapperDiv = document.createElement('div');
        wrapperDiv.className = 'message-wrapper';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        const messageText = document.createElement('div');
        messageText.textContent = message;
        
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = formatTime(timestamp || new Date());
        
        contentDiv.appendChild(messageText);
        wrapperDiv.appendChild(contentDiv);
        wrapperDiv.appendChild(timeDiv);
        messageDiv.appendChild(wrapperDiv);
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Show/hide typing indicator
    function toggleTyping(show) {
        const typingIndicator = document.getElementById('typingIndicator');
        if (show) {
            typingIndicator.classList.add('active');
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        } else {
            typingIndicator.classList.remove('active');
        }
    }

    // Voice recording functions
    async function initializeVoiceRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
            
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordingChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(recordingChunks, { type: 'audio/webm' });
                recordingChunks = [];
                await transcribeAudio(audioBlob);
            };
            
            return true;
        } catch (error) {
            console.error('Error accessing microphone:', error);
            showError('Microphone access denied. Please enable microphone permissions.');
            return false;
        }
    }

    async function transcribeAudio(audioBlob) {
        const voiceStatus = document.getElementById('voiceStatus');
        voiceStatus.textContent = '🔄 Converting speech to text...';
        voiceStatus.classList.add('active');
        
        try {
            // Convert blob to base64
            const base64Audio = await blobToBase64(audioBlob);
            
            // Use Web Speech API for transcription (fallback method)
            // Note: For production, you'd want to use a more robust service like Google Speech-to-Text
            const transcription = await transcribeWithWebSpeechAPI(audioBlob);
            
            if (transcription && transcription.trim()) {
                document.getElementById('chatInput').value = transcription;
                voiceStatus.classList.remove('active');
                
                // Auto-send the message
                setTimeout(() => {
                    sendMessage();
                }, 500);
            } else {
                throw new Error('No speech detected');
            }
            
        } catch (error) {
            console.error('Transcription error:', error);
            voiceStatus.classList.remove('active');
            showError('Could not convert speech to text. Please try again.');
        }
    }

    // Fallback transcription using Web Speech API
    function transcribeWithWebSpeechAPI(audioBlob) {
        return new Promise((resolve, reject) => {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                // Simple fallback - just indicate that voice was received
                resolve("Voice message received (transcription not available in this browser)");
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                resolve(transcript);
            };

            recognition.onerror = (event) => {
                reject(new Error('Speech recognition error: ' + event.error));
            };

            recognition.onend = () => {
                // If no result was captured, resolve with a fallback message
                setTimeout(() => resolve("Voice message received"), 100);
            };

            // Create audio element to play the recorded audio for recognition
            const audio = new Audio(URL.createObjectURL(audioBlob));
            audio.play();
            recognition.start();
            
            // Stop recognition after 5 seconds if no result
            setTimeout(() => {
                recognition.stop();
            }, 5000);
        });
    }

    function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    }

    function startVoiceRecording() {
        if (!mediaRecorder) {
            showError('Voice recording not available. Please check microphone permissions.');
            return;
        }

        recordingChunks = [];
        mediaRecorder.start();
        isRecording = true;
        
        const voiceBtn = document.getElementById('voiceBtn');
        const voiceStatus = document.getElementById('voiceStatus');
        
        voiceBtn.classList.add('recording');
        voiceStatus.textContent = '🎤 Recording... Release to send';
        voiceStatus.classList.add('active');
        
        console.log('Started voice recording');
    }

    // Show error message
    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.classList.add('active');
        setTimeout(() => {
            errorDiv.classList.remove('active');
        }, 5000);
    }

    // Save message to Supabase
    async function saveToSupabase(message, sender) {
        // Check if Supabase is configured properly
        if (!CONFIG.SUPABASE_URL || 
            CONFIG.SUPABASE_URL === 'PLACEHOLDER_SUPABASE_URL' ||
            !CONFIG.SUPABASE_URL.startsWith('https://') ||
            !CONFIG.SUPABASE_ANON_KEY ||
            CONFIG.SUPABASE_ANON_KEY === 'PLACEHOLDER_SUPABASE_KEY' ||
            CONFIG.SUPABASE_ANON_KEY.length < 20) {
            console.log('Supabase not configured - messages will not be saved');
            console.log('Debug - URL:', CONFIG.SUPABASE_URL ? 'Set (' + CONFIG.SUPABASE_URL.substring(0, 20) + '...)' : 'Not set');
            console.log('Debug - Key:', CONFIG.SUPABASE_ANON_KEY ? 'Set (' + CONFIG.SUPABASE_ANON_KEY.length + ' chars)' : 'Not set');
            return;
        }

        try {
            const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/chat_messages`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': CONFIG.SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify({
                    user_id: userId,
                    session_id: sessionId,
                    message: message,
                    sender: sender,
                    timestamp: new Date().toISOString()
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Supabase save error:', response.status, errorText);
                throw new Error(`Failed to save to Supabase: ${response.status}`);
            } else {
                console.log(`✅ Saved ${sender} message to Supabase for user: ${userId}`);
            }
        } catch (error) {
            console.error('Supabase save error:', error);
            // Show more specific error information
            if (error.message.includes('404')) {
                console.error('❌ Supabase table "chat_messages" not found. Please create the table.');
            } else if (error.message.includes('401') || error.message.includes('403')) {
                console.error('❌ Supabase authentication failed. Check your API key.');
            } else if (error.message.includes('400')) {
                console.error('❌ Supabase request error. Check your table structure.');
            }
            // Don't show error to user for save failures, just log it
        }
    }

    // Load chat history from Supabase
    async function loadChatHistory() {
        // Check if Supabase is configured properly
        if (!CONFIG.SUPABASE_URL || 
            CONFIG.SUPABASE_URL === 'PLACEHOLDER_SUPABASE_URL' ||
            !CONFIG.SUPABASE_URL.startsWith('https://') ||
            !CONFIG.SUPABASE_ANON_KEY ||
            CONFIG.SUPABASE_ANON_KEY === 'PLACEHOLDER_SUPABASE_KEY' ||
            CONFIG.SUPABASE_ANON_KEY.length < 20) {
            console.log('Supabase not configured - chat history will not be loaded');
            console.log('Debug - URL valid:', CONFIG.SUPABASE_URL && CONFIG.SUPABASE_URL.startsWith('https://'));
            console.log('Debug - Key valid:', CONFIG.SUPABASE_ANON_KEY && CONFIG.SUPABASE_ANON_KEY.length > 20);
            return;
        }

        try {
            const response = await fetch(
                `${CONFIG.SUPABASE_URL}/rest/v1/chat_messages?user_id=eq.${userId}&order=timestamp.asc&limit=50`,
                {
                    headers: {
                        'apikey': CONFIG.SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
                    }
                }
            );

            if (response.ok) {
                const messages = await response.json();
                console.log(`📚 Loading ${messages.length} previous messages for user: ${userId}`);
                
                if (messages.length > 0) {
                    // Clear the initial welcome message if we have history
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    
                    // Load previous messages
                    messages.forEach(msg => {
                        chatHistory.push({
                            role: msg.sender === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.message }]
                        });
                        
                        addMessageToUI(msg.message, msg.sender, new Date(msg.timestamp), true);
                    });
                    
                    console.log('✅ Chat history loaded successfully');
                } else {
                    console.log('📝 No previous chat history found for this user');
                }
            } else {
                console.error('Failed to load chat history:', response.status);
            }
        } catch (error) {
            console.error('Failed to load chat history:', error);
        }
    }

    // Call Gemini API
    async function callGeminiAPI(userMessage) {
        // Simple validation - just check if key exists and is long enough
        if (!CONFIG.GEMINI_API_KEY || CONFIG.GEMINI_API_KEY.length < 30) {
            return "Configuration error: API key not configured.";
        }

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${CONFIG.GEMINI_API_KEY}`;
        
        const messages = chatHistory.length === 0 
            ? [{ role: 'user', parts: [{ text: systemPrompt + '\n\nUser: ' + userMessage }] }]
            : [...chatHistory, { role: 'user', parts: [{ text: userMessage }] }];

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: messages,
                    generationConfig: {
                        temperature: 0.7,
                        topK: 1,
                        topP: 1,
                        maxOutputTokens: 2048,
                    }
                })
            });

            if (!response.ok) {
                throw new Error(`API request failed: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                const botResponse = data.candidates[0].content.parts[0].text;
                
                chatHistory.push(
                    { role: 'user', parts: [{ text: userMessage }] },
                    { role: 'model', parts: [{ text: botResponse }] }
                );
                
                return botResponse;
            } else {
                throw new Error('Invalid response from API');
            }
        } catch (error) {
            console.error('Gemini API error:', error);
            return "I'm sorry, I encountered an error. Please try again later.";
        }
    }

    // Send message
    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const message = input.value.trim();
        
        if (!message) return;
        
        input.disabled = true;
        sendBtn.disabled = true;
        
        addMessageToUI(message, 'user');
        input.value = '';
        
        // Save user message to Supabase
        await saveToSupabase(message, 'user');
        
        toggleTyping(true);
        
        try {
            const botResponse = await callGeminiAPI(message);
            toggleTyping(false);
            addMessageToUI(botResponse, 'bot');
            
            // Save bot response to Supabase
            await saveToSupabase(botResponse, 'bot');
            
        } catch (error) {
            toggleTyping(false);
            showError('Failed to get response. Please try again.');
        } finally {
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }
    }

    // Handle enter key
    function handleKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    // Settings functions
    function openSettings() {
        document.getElementById('settingsModal').classList.add('active');
        document.getElementById('userIdInput').value = userId;
        document.getElementById('systemPromptInput').value = systemPrompt;
    }

    function closeSettings() {
        document.getElementById('settingsModal').classList.remove('active');
    }

    function saveSettings() {
        const newUserId = document.getElementById('userIdInput').value.trim() || generateUserId();
        const newSystemPrompt = document.getElementById('systemPromptInput').value.trim() || CONFIG.DEFAULT_SYSTEM_PROMPT;
        
        // Only reset if user ID changed
        if (newUserId !== userId) {
            userId = newUserId;
            localStorage.setItem('userId', userId);
            sessionId = generateSessionId();
            chatHistory = [];
            
            // Clear chat and reload history for new user
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '<div class="message bot"><div class="message-avatar">🤖</div><div class="message-wrapper"><div class="message-content"><div>Hello! I\'m Elle, your gut health assistant. How can I help you today?</div></div><div class="message-time"></div></div></div>';
            loadChatHistory();
        }
        
        systemPrompt = newSystemPrompt;
        localStorage.setItem('systemPrompt', systemPrompt);
        
        closeSettings();
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('🚀 Chatbot initialized');
        
        // Set up event listeners
        document.getElementById('chatInput').addEventListener('keypress', handleKeyPress);
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('cancelSettings').addEventListener('click', closeSettings);
        document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
        
        // Handle Adalo userId parameter (IMPORTANT for Adalo integration)
        const urlParams = new URLSearchParams(window.location.search);
        const adaloUserId = urlParams.get('userId');
        if (adaloUserId && adaloUserId.trim()) {
            userId = adaloUserId.trim();
            localStorage.setItem('userId', userId);
            sessionId = generateSessionId(); // New session for this user
            console.log('🔗 Using Adalo userId:', userId);
        }
        
        // Load chat history for this user
        await loadChatHistory();
        
        // Show settings button if admin mode
        if (urlParams.get('admin') === 'true') {
            const settingsBtn = document.getElementById('settingsButton');
            settingsBtn.style.display = 'block';
            settingsBtn.addEventListener('click', openSettings);
        }
        
        // Focus input
        document.getElementById('chatInput').focus();
    });

    // Handle messages from Adalo (additional integration)
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'ADALO_USER_ID' && event.data.userId) {
            const newUserId = event.data.userId.trim();
            if (newUserId !== userId) {
                userId = newUserId;
                localStorage.setItem('userId', userId);
                sessionId = generateSessionId();
                chatHistory = [];
                console.log('📱 Received Adalo userId via postMessage:', userId);
                
                // Clear and reload chat history
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '<div class="message bot"><div class="message-avatar">🤖</div><div class="message-wrapper"><div class="message-content"><div>Hello! I\'m Elle, your gut health assistant. How can I help you today?</div></div><div class="message-time"></div></div></div>';
                loadChatHistory();
            }
        }
    });
</script>
</body>
</html>
