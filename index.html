<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elle - Your Gut Health Assistant</title>
    <style>
        /* Modern Chat Interface with Brand Colors */
        :root {
            --primary-green: #226137;
            --primary-pink: #FCB1A8;
            --light-green: #2d7d4a;
            --light-pink: #ffd0c7;
            --background: #ffffff;
            --surface: #f8f9fa;
            --surface-light: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #f8fafb 0%, #e8f5ee 50%, #fff5f3 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 50%, rgba(34, 97, 55, 0.03) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(252, 177, 168, 0.03) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -50px) rotate(120deg); }
            66% { transform: translate(-20px, 20px) rotate(240deg); }
        }

        .chat-container {
            width: 100%;
            max-width: 500px;
            height: 95vh;
            max-height: 800px;
            background: var(--background);
            border-radius: 30px;
            box-shadow: 0 25px 70px rgba(34, 97, 55, 0.15),
                        0 10px 30px rgba(252, 177, 168, 0.1),
                        0 0 0 1px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            backdrop-filter: blur(10px);
        }

        .chat-header {
            background: var(--surface-light);
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .chat-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #226137 0%, #4a9d6a 25%, #7bc99d 50%, #FCB1A8 75%, #ffd4cb 100%);
            background-size: 200% auto;
            animation: gradient-shift 3s ease infinite;
        }

        @keyframes gradient-shift {
            0%, 100% { background-position: 0% center; }
            50% { background-position: 100% center; }
        }

        .bot-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #226137 0%, #2d7d4a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 8px 20px rgba(34, 97, 55, 0.3);
            position: relative;
        }

        .bot-avatar::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: #00ff88;
            border-radius: 50%;
            bottom: 2px;
            right: 2px;
            border: 3px solid var(--surface-light);
            box-shadow: 0 0 10px #00ff88;
        }

        .bot-info {
            flex: 1;
        }

        .bot-name {
            font-size: 26px;
            font-weight: 800;
            background: linear-gradient(90deg, #226137 0%, #4a9d6a 25%, #7bc99d 50%, #FCB1A8 75%, #ffd4cb 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
            letter-spacing: -0.8px;
            animation: gradient-shift 3s ease infinite;
        }

        .bot-status {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: var(--surface);
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #226137, #2d7d4a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(34, 97, 55, 0.2);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #FCB1A8, #ffd0c7);
            box-shadow: 0 4px 12px rgba(252, 177, 168, 0.3);
        }

        .message-content {
            max-width: 75%;
            padding: 14px 18px;
            border-radius: 20px;
            line-height: 1.6;
            position: relative;
            word-wrap: break-word;
        }

        .message.bot .message-content {
            background: var(--surface-light);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #FCB1A8 0%, #ffc9be 50%, #ffd4cb 100%);
            border-bottom-right-radius: 6px;
            box-shadow: 0 10px 25px rgba(252, 177, 168, 0.35);
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 6px;
            padding: 0 18px;
        }

        .message.user .message-time {
            text-align: right;
        }

        .typing-indicator {
            display: none;
            padding: 16px 20px;
            background: var(--surface-light);
            border-radius: 20px;
            border-bottom-left-radius: 6px;
            border: 1px solid var(--border-color);
            width: fit-content;
            margin-left: 48px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .typing-indicator.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .typing-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin: 0 3px;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            background: #226137;
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            background: #2d7d4a;
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            background: #FCB1A8;
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-12px);
                opacity: 1;
            }
        }

        .chat-input-container {
            padding: 25px;
            background: var(--surface-light);
            border-top: 1px solid var(--border-color);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
            background: var(--surface);
            border-radius: 25px;
            padding: 6px;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .input-wrapper:focus-within {
            border-color: #226137;
            box-shadow: 0 0 0 3px rgba(34, 97, 55, 0.1);
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            font-size: 15px;
            outline: none;
            background: linear-gradient(135deg, #226137 0%, #4a9d6a 25%, #7bc99d 50%, #FCB1A8 75%, #ffd4cb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }

        .chat-input::placeholder {
            color: var(--text-secondary);
            -webkit-text-fill-color: var(--text-secondary);
            opacity: 1;
        }

        .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #226137 0%, #2d7d4a 50%, #4a9d6a 100%);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 6px 20px rgba(34, 97, 55, 0.4);
            position: relative;
            overflow: hidden;
        }

        .send-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .send-btn:hover:not(:disabled)::before {
            left: 100%;
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.15) rotate(20deg);
            box-shadow: 0 8px 25px rgba(34, 97, 55, 0.6);
        }

        .send-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            background: rgba(252, 177, 168, 0.2);
            color: #d63031;
            padding: 12px 18px;
            border-radius: 12px;
            margin: 0 25px 10px;
            font-size: 14px;
            display: none;
            border-left: 4px solid #FCB1A8;
            animation: slideIn 0.3s ease;
        }

        .error-message.active {
            display: block;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #226137, #2d7d4a);
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #2d7d4a, #226137);
        }

        .welcome-message {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(34, 97, 55, 0.05) 0%, rgba(252, 177, 168, 0.05) 100%);
            border-radius: 20px;
            border: 2px solid var(--border-color);
            margin-bottom: 10px;
        }

        .welcome-message .welcome-title {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(90deg, #226137 0%, #4a9d6a 25%, #7bc99d 50%, #FCB1A8 75%, #ffd4cb 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: -0.8px;
            animation: gradient-shift 3s ease infinite;
        }

        .welcome-message .welcome-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
            line-height: 1.6;
        }

        @media (max-width: 600px) {
            body {
                padding: 0;
            }
            .chat-container {
                height: 100vh;
                max-width: 100%;
                border-radius: 0;
            }
            .message-content {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="bot-avatar">ü§ñ</div>
            <div class="bot-info">
                <div class="bot-name">Elle</div>
                <div class="bot-status">
                    <span class="status-dot"></span>
                    Your Gut Health Assistant
                </div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                <div class="welcome-title">Hi, I'm Elle! üëã</div>
                <div class="welcome-subtitle">Your personal gut health assistant. Ask me anything about digestive health, nutrition, and wellness.</div>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="chat-input-container">
            <div class="input-wrapper">
                <input 
                    type="text" 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="Type your message..."
                    autocomplete="off"
                >
                <button class="send-btn" id="sendBtn">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration - These placeholders will be replaced by GitHub Actions
        const CONFIG = {
            GEMINI_API_KEY: 'PLACEHOLDER_GEMINI_KEY',
            SUPABASE_URL: 'PLACEHOLDER_SUPABASE_URL',
            SUPABASE_ANON_KEY: 'PLACEHOLDER_SUPABASE_KEY',
            DEFAULT_SYSTEM_PROMPT: 'You are Elle, a specialized gut health assistant. You help users with digestive health questions, gut microbiome information, probiotic and prebiotic guidance, IBS, IBD, and digestive disorder support, and nutrition for gut health. Always be friendly, supportive, and remind users to consult healthcare professionals for serious issues.',
        };

        // Log configuration status - DEBUG MODE
        console.log('ü§ñ Elle Chatbot Initialization - DEBUG MODE v2');
        console.log('===========================================');
        console.log('Raw API Key:', CONFIG.GEMINI_API_KEY);
        console.log('API Key starts with AIza?:', CONFIG.GEMINI_API_KEY.startsWith('AIza'));
        console.log('API Key Length:', CONFIG.GEMINI_API_KEY.length);
        console.log('===========================================');
        
        // Check if API key is actually configured (starts with AIza and is right length)
        const isValidKey = CONFIG.GEMINI_API_KEY.startsWith('AIza') && 
                          CONFIG.GEMINI_API_KEY.length >= 35 && 
                          CONFIG.GEMINI_API_KEY.length <= 45;
        
        if (isValidKey) {
            console.log('‚úÖ API Key is VALID and ready to use!');
        } else {
            console.error('‚ùå API Key not configured properly');
            console.error('Current value:', CONFIG.GEMINI_API_KEY);
        }

        // Generate anonymous user ID
        let userId = localStorage.getItem('anonymous_userId') || generateAnonymousId();
        let sessionId = generateSessionId();
        let chatHistory = [];

        function generateAnonymousId() {
            const id = 'anon_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('anonymous_userId', id);
            return id;
        }

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function formatTime(date) {
            return new Intl.DateTimeFormat('en-US', {
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            }).format(date);
        }

        function addMessageToUI(message, sender, timestamp = null) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.textContent = sender === 'bot' ? 'ü§ñ' : 'üë§';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // Apply ombre gradient to text
            const textContent = document.createElement('span');
            textContent.textContent = message;
            textContent.style.cssText = 'background: linear-gradient(135deg, #226137 0%, #4a9d6a 25%, #7bc99d 50%, #FCB1A8 75%, #ffd4cb 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 600;';
            contentDiv.appendChild(textContent);
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = formatTime(timestamp || new Date());
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.appendChild(timeDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function toggleTyping(show) {
            const typingIndicator = document.getElementById('typingIndicator');
            if (show) {
                typingIndicator.classList.add('active');
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else {
                typingIndicator.classList.remove('active');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
            setTimeout(() => {
                errorDiv.classList.remove('active');
            }, 8000);
        }

        async function saveToSupabase(message, sender) {
            if (!CONFIG.SUPABASE_URL || 
                CONFIG.SUPABASE_URL === 'PLACEHOLDER_SUPABASE_URL' ||
                !CONFIG.SUPABASE_URL.startsWith('https://') ||
                !CONFIG.SUPABASE_ANON_KEY ||
                CONFIG.SUPABASE_ANON_KEY === 'PLACEHOLDER_SUPABASE_KEY') {
                return;
            }

            try {
                const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/chat_messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': CONFIG.SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        session_id: sessionId,
                        message: message,
                        sender: sender,
                        timestamp: new Date().toISOString()
                    })
                });

                if (response.ok) {
                    console.log('‚úÖ Message saved to Supabase');
                }
            } catch (error) {
                console.error('Failed to save to Supabase:', error);
            }
        }

        async function loadChatHistory() {
            if (!CONFIG.SUPABASE_URL || 
                CONFIG.SUPABASE_URL === 'PLACEHOLDER_SUPABASE_URL' ||
                !CONFIG.SUPABASE_ANON_KEY ||
                CONFIG.SUPABASE_ANON_KEY === 'PLACEHOLDER_SUPABASE_KEY') {
                return;
            }

            try {
                const response = await fetch(
                    `${CONFIG.SUPABASE_URL}/rest/v1/chat_messages?user_id=eq.${userId}&order=timestamp.asc&limit=50`,
                    {
                        headers: {
                            'apikey': CONFIG.SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const messages = await response.json();
                    
                    if (messages.length > 0) {
                        messages.forEach(msg => {
                            chatHistory.push({
                                role: msg.sender === 'user' ? 'user' : 'model',
                                parts: [{ text: msg.message }]
                            });
                            
                            addMessageToUI(msg.message, msg.sender, new Date(msg.timestamp));
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load chat history:', error);
            }
        }

        async function callGeminiAPI(userMessage) {
            // Check if API key is configured - improved detection
            const isPlaceholder = CONFIG.GEMINI_API_KEY === 'PLACEHOLDER_GEMINI_KEY' || 
                                  CONFIG.GEMINI_API_KEY.includes('PLACEHOLDER');
            
            if (!CONFIG.GEMINI_API_KEY || 
                isPlaceholder || 
                CONFIG.GEMINI_API_KEY.length < 20) {
                return "‚ö†Ô∏è API Configuration Required: Please add your Gemini API key to GitHub Secrets. Get a free API key at https://makersuite.google.com/app/apikey";
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${CONFIG.GEMINI_API_KEY}`;
            
            const messages = chatHistory.length === 0 
                ? [{ role: 'user', parts: [{ text: CONFIG.DEFAULT_SYSTEM_PROMPT + '\n\nUser: ' + userMessage }] }]
                : [...chatHistory, { role: 'user', parts: [{ text: userMessage }] }];

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: messages,
                        generationConfig: {
                            temperature: 0.7,
                            topK: 1,
                            topP: 1,
                            maxOutputTokens: 2048,
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('API Error:', response.status, errorData);
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const botResponse = data.candidates[0].content.parts[0].text;
                    
                    chatHistory.push(
                        { role: 'user', parts: [{ text: userMessage }] },
                        { role: 'model', parts: [{ text: botResponse }] }
                    );
                    
                    return botResponse;
                } else {
                    throw new Error('Invalid response from API');
                }
            } catch (error) {
                console.error('Gemini API error:', error);
                
                if (error.message.includes('404')) {
                    return "‚ö†Ô∏è API Error: The Gemini API endpoint could not be found. Please verify your API key is correct and active.";
                } else if (error.message.includes('401') || error.message.includes('403')) {
                    return "‚ö†Ô∏è Authentication Error: Your API key is invalid or expired. Please update your GitHub Secret with a valid key.";
                } else if (error.message.includes('429')) {
                    return "‚ö†Ô∏è Rate Limit: Too many requests. Please wait a moment and try again.";
                } else {
                    return "I'm sorry, I encountered an error connecting to the AI service. Please check the console for details and try again.";
                }
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = input.value.trim();
            
            if (!message) return;
            
            input.disabled = true;
            sendBtn.disabled = true;
            
            addMessageToUI(message, 'user');
            input.value = '';
            
            await saveToSupabase(message, 'user');
            
            toggleTyping(true);
            
            try {
                const botResponse = await callGeminiAPI(message);
                toggleTyping(false);
                addMessageToUI(botResponse, 'bot');
                await saveToSupabase(botResponse, 'bot');
            } catch (error) {
                toggleTyping(false);
                showError('Failed to get response. Please try again.');
            } finally {
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('‚úÖ Elle chatbot initialized');
            
            document.getElementById('chatInput').addEventListener('keypress', handleKeyPress);
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            
            await loadChatHistory();
            
            document.getElementById('chatInput').focus();
        });
    </script>
</body>
</html>
